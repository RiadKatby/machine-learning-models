# نموذج المجيب الآلي Chatbot
يعتبر فهم المقاصد في اللغات الطبيعية أحد اهم تطبيقات تعلم الآلة، وفي هذا المقال سنتعلم كيف نبني نموذج **تعلم عميق** يستطيع فهم المقاصد من الجمل ويعمل كدعم فني للرد على العملاء وتنفيذ طلباتهم وتقديم الخدمات لهم آلياً.

سنعمل على مثال لجهة افتراضية مسؤولة عن ادارة الرخص وتنوي تقديم خدماتها من خلال المجيب الآلي Chatbot. تمثل البيانات عينة من أسئلة العملاء، وتنقسم إلى 5 خدمات رئيسية وهي: اصدار وتجديد وتعديل وشطب واستعراض الرخص.

## الخطوة 1 - تحميل البيانات
سنقوم بتحميل مجموعة البيانات الموجودة في ملف CSV إلى جدول بيانات **Panda** لنتمكن من التعامله معه بحرية وسهولة، وقد قمنا بكتابة الدالة `load_dataset` لتعزيز اعادة الاستخدام في حال اردنا اعادة تحميل البيانات من الملف إذا اضيف له بيانات جديدة أو أن جدول بيانات Panda قد تغير واردت الحصول على البيانات من جديد.

## الخطوة 2 - معالجة بيانات الدخل
تتكون البيانات من عمودين / ميزتين سيكون عمود *السؤال* هو عمود الدخل وعمود *الخدمة* هو عمود الخرج. يحتوي عمود السؤال على كافة الأسئلة للخدمات الخمسة سابقة الذكر، ويحتوي عمود الخدمة على المقصد أو الخدمة المقصود تنفيذها من هذا السؤال.

تتألف معالجة بيانات الدخل (معالجة الأسئلة) من 4 خطوات رئيسية تُنفذ عمود السؤال وتفيد بزيادة دقة النموذج بالتعرف على المقصد من السؤال أو على الخدمة التي يريد العميل تنفيذها وهي كما يلي
1. تقسيم كل سؤال إلى كلمات كي تتم معالجة كل منها على حدى
2. إزالة كلمات التوقف مثل حروف الجر وبعض حروف التوكيد والاشارة لأنها لا تلعب دور مهم في التعرف على المقصد
3. تبديل الكلمة بجذرها ما يقلل على الكلمات الداخلة للنموذج ويمكنه من التعرف على المقصد بدقة اعلى
4. اعادة تجميل الكلمة بسطر واحد

قمنا أيضاً بكتابة خطوات المعالجة في الدالة `preprocess` لنتمكن من اعادة استخدامها عندما يقوم العميل بطلب احدى الخدمات الخمسة في البيئة الإنتاجية

## الخطوة 3 - معالجة بيانات الخرج
تفحص البيانات وستجدل أن لدينا في حقل *الخدمة* خمس قيم مختلفة كما يلي [اصدار الرخصة، تجديد الرخصة، تعديل الرخصة، شطب الرخصة، استعراض الرخصة] وحتى نتمكم من ادخال هذه القيم الخمسة إلى نموذج **التعلم العميق** ونحصل على ميزة **هل تقصد** التي تراها غالباً عندما تسأل المجيب الآلي ولا يكون متأكد من أنه فهم الطلب فسنستخدم ترميز ال OneHot والذي يرمز كل قيمة من حقل **الخدمة** في مصفوفة تحتوي الرقم 1 بالحجرة المقابلة للخدمة فمثلاً إذا اردنا ترميز تجديد الرخصة فستكون على الشكل التالي [0, 1, 0, 0, 0] واستعراض الرخصة ستكون على الشكل التالي [0, 0, 0, 0, 1]

## الخطوة 4 - خلط البيانات وقسمها إلى مجموعتي تدريب واختبار
سنقوم أولاً بخلط البيانات لا يتعلم النموذج عندما يعمل على البيئة الإنتاجية بأن الأسئلة ستأتيه بنفس الترتيب التي أتت به عند التدريب، ثم سنأخذ 80% من هذه البيانات ندرب عليها النموذج نستعمل ال 20% المتبقية لإختبار دقة النموذج عليها عندها سنحصل على نسبة الدقة الأقرب لتلك التي سنحصل عليها في البيئة الإنتاجية لأننا لم نري النموذج أي جزء من مجموعة الاختبار ال 20% أثناء تدربه.

## الخطوة 5 - تحويل الأسئلة إلى سلاسل متساوية الأطوال
لاحظ أن عدد الكلمات في كل سؤال مختلف عن الأخر وهذا ما لايمكن لنموذج التعلم العميق التعامل معه لذلك سنقوم أولا بإنشاء معجم بكافة الكلمات التي تؤلف كافة الاسئلة الموجودة في البيانات `tokenizer`. ثانياً سنقوم بإنشاء مصفوفة جديدة لكافة الأسئلة تحتوي على الدليل الرقمي للكلمة في المعجم بدلاً من الكلمة نفسها لأنه وكما نعلم فإن النموذج يحب التعامل مع الأرقام بدلاً من الكلامات `text_to_sequences`. ثالثاً سنقوم بإضافة قيم صفرية بنهاية `padding_type=100` كل سلسلة لتصبح جميعاً بالطول نفسه وهو 100 `max_length=100`. رابعاً وأخيراً سنقوم بتنفيذ الخطوات الثلاثة السابقة على كلاً من مجموعتي التدريب والإختبار.

## الخطوة 6 - بناء نموذج التعلم العميق
سيتألف نموذجنا من 4 طبقات كما يلي:
1. الطبقة الأولى `Embedding` والتي ستعمل على تحويل أدلة الكلمات من سلسلة الأسئلة `input_length=max_length` إلى متجهات ذات قيمة مكثفة وطول موحد `embedding_dim = 16` 
2. الطبقة الثانية `Bidirectional(LSTM)` ستقوم بنمذجة سلاسل الأسئلة القادمة من المتجهات المكثفة في الطبقة السابقة لإيجاد العلاقات بين الكلمات واستخراج أنماط ترددها المتسلسل
3. الطبقة الثالثة `Dense` تعمل على نمذجة العلاقة بين خلايا الذاكرة طويلة \ قصيرة الأجل من الطبقة الثانية مع خلايا الطبقة الرابعة
4. الطبقة الرابعة `Dense` تقوم بتقديم الخرج النموذج كتنبؤ بإحتمال موزع على 5 خلاياً وبما أن مجموع قيم الاحتمال يساوي الواحد فإنه الخلية ذات الاحتمال الأكبر هي قصد العميل من السؤال

وسنستخدم `categorical_crossentropy` كدالة الخسارة لأنها تمكن النموذج من توليد العديد من القيمة على الخرج وفي حالتنا سيكون الخرج مؤلفاً من 5 قيم هي الخدمات وسيكون مجموع القيم الخمسة يساوي الواحد وبالتالي سيكون الخرج ذو القيمة الكبرى هو الخدمة المقصودة والتي يريد العميل تنفيذها. وستعمل دالة Adamax على تحسين أداء النموذج مع كل دورة تدريب من ال 40 دورة كما سنجد في الخطوة رقم 7. وسيتم استخدام الدقة `accuracy` كمقياس أداء نقيس بهم تحسن أداء النموذج في دورات التعليم ال 40 حيث كلما اقتربت الدقة من 1 يكون النموذج قد تحسن بشكل متقن.


## الخطوة 7 - تدريب النموذج والتحقق من صحته
سنقوم بتدريب النموذج على 40 حقبة تعليمة نعمل بكل منها على تحسين أداء النموذج بإستخدام بيانات التدريب ثم نقوم بالتحقق من دقته باستخدام بيانات الاختبار، في هذه الخطوة نجني ثمار كل العمل السابق لذلك هي من أقصر الخطوات وأكثرهم استهلاكاً لوقت التنفيذ.

## الخطوة 8 - رسم الدقة والخسارة مقابل حقب التدريب
سنقوم برسم كلاً من دقة النموذج على بيانات التدريب ودقته على بيانات الاختبار مقابل حقب التدريب ال 40، يعتبر هذا الرسم البيانات مهم لأنه يوضح كيفية تحسن دقة النموذج في كل حقبة تعليمية ويكون خط البيان `val_accuracy` المرتبط ببيانات الاختبار هو الأهم لأنه الأقرب لدقة النموذج على البيئة الإنتاجية. ثم سنقوم برسم خسارة النموذج مع كل حقبة تعليمية طبعاً يجب أن تقل الخسارة مع كل حقبة إذا كان النموذج يتحسن ويتعلم بإستمرار سيكون الأداء الأفضل عندما تصل الخسارة إلى الصفر وذلك أقرب ما يكون إلى المستحيل

## الخطوة 9 - اختبار وتجريب النموذج
هنا سنجني ثمار كل العمل في الخطوات الثمانية السابقة وسنقوم بتجريب النموذج بأنفسنا نعطيه أي جملة موجودة أو غير موجودة في بيانات التدريب والاختبار لنتوقع منه أن يعطينا احتمال ان يكون هذا السؤال ينتمي إلى واحدة من الخدمات الخمسة السابقة، نستطيع أيضاً أن نقوم بترتيب قيم الخرج ال 5 من الأكبر إلى الأصغر لنقول للعميل هل تقصد الأول أم الثاني أم الثالث، إذا لم تكون دقة الإجابة الأولى مثلاً تتجاوز عتبة معينة ولتكون 80%.

ارجو أن تقوم بنسخ الكود والبيانات إلى جهازك تجريبها وطبعاً أي ملاحظة ستكون موضع ترحيب كبير
شكراً للقراءة
